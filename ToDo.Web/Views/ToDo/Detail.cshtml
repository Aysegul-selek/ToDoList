@model List<ToDoAPI.Entities.DTOs.ToDo.TodoDto>

<h1>ToDo List</h1>
<table class="table table-striped">
    <thead>
        <tr>
            <th>Title</th>
            <th>Description</th>
            <th>Status</th>
            <th>User</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var todo in Model)
        {
            <tr>
                <td>@todo.Title</td>
                <td>@todo.Description</td>
                <td>@todo.Status</td>
                <td>@todo.UserName</td>
                <td>
                    <button class="btn btn-warning btn-sm edit-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#editModal"
                            data-id="@todo.TodoId"
                            data-title="@todo.Title"
                            data-description="@todo.Description"
                            data-status="@((int)Enum.Parse(typeof(ToDoAPI.Entities.Enums.StatusEnum), todo.Status))"
                            data-userid="@todo.UserId"
                            data-username="@todo.UserName">
                        ✏️ Update
                    </button>

                    <form asp-action="Delete" asp-controller="ToDo" method="post" asp-route-id="@todo.TodoId"
                          style="display:inline;" onsubmit="return confirm('Bu görevi silmek istediğine emin misin?');">
                        <button type="submit" class="btn btn-danger btn-sm">🗑 Delete</button>
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- EDIT MODAL -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editForm">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Todo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="todoId" />

                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input class="form-control" id="title" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="description"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-control" id="status">
                            @foreach (var s in Enum.GetValues(typeof(ToDoAPI.Entities.Enums.StatusEnum)))
                            {
                                <option value="@((int)s)">@s.ToString()</option>
                            }
                        </select>
                    </div>

                    <!-- USER FIELDS VISIBLE -->
                    <div class="mb-3">
                        <label class="form-label">User ID</label>
                        <input type="number" class="form-control" id="userId" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">User Name</label>
                        <input type="text" class="form-control" id="userName" />
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('todoId').value = btn.dataset.id;
                    document.getElementById('title').value = btn.dataset.title;
                    document.getElementById('description').value = btn.dataset.description;
                    document.getElementById('status').value = btn.dataset.status;
                    document.getElementById('userId').value = btn.dataset.userid;
                    document.getElementById('userName').value = btn.dataset.username;
                });
            });

            document.getElementById('editForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('todoId').value;

                const payload = {
                    Title: document.getElementById('title').value,
                    Description: document.getElementById('description').value,
                    Status: parseInt(document.getElementById('status').value),
                    UserId: parseInt(document.getElementById('userId').value),
                    UserName: document.getElementById('userName').value
                };

                try {
                           const apiBase = "https://localhost:44305/api/Todo"; 
        const res = await fetch(`${apiBase}/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

                    if (!res.ok) {
                        const errText = await res.text();
                        alert('Update failed!\n' + errText);
                        return;
                    }

                    alert('Updated successfully!');
                    location.reload();
                } catch (err) {
                    console.error('Fetch error:', err);
                    alert('Update failed due to network or server error.');
                }
            });
        });
    </script>
}
